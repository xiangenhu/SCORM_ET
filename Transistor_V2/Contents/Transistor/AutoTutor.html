<html>
<head>
    <style type="text/css">
        body {
            background-image: url('../BundleFlowChart/ONR.png');
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-position: 30% 20%;
        }
    </style>

    <script language=javascript src="../util/APIWrapper.js"></script>
    <script language=javascript src="ET.js"></script>
    <script language=javascript>
        // Set some variables global to the SCO
        var answer = -1;
        var exitPageStatus = false;
        var ATType = GetQueryVar("ATType", "AutoTutorDR")
        var BundleTitle = GetQueryVar("T", "Transistor");
        var ATScoreMessage;
        var ATKcName;
        var ATScore;
        var Threshold = 0.5;

        window.addEventListener("message",
            function submitScore(evt) {
                if (evt.origin === "http://prod.x-in-y.com" || evt.origin === "https://prod.x-in-y.com") {
                    ATScoreMessage = evt.data;
                    var getScore = ATScoreMessage.ETScore;
                    if (getScore == true) {
                        ATKcName = ATScoreMessage.KcName;
                        ATScore = ATScoreMessage.KcScore;
                    }
                }

                var val = "";
                if (ATScore < Threshold) {
                    val = "Low";
                } else {
                    val = "High";
                }
                document.getElementById("ATscore").innerHTML = 'Topic Name: ' + BundleTitle + '<br>' + 'Type of Question: ' + ATType + '<br>' + 'Knowledge Component: ' + ATKcName + '<br>' + 'Score: ' + ATScore + '<br>' + 'Overall Performance (Threshold  = 0.5): ' + val;
                var indexOfFirstObjective = findObjective(BundleTitle + "_" + ATType + "_High");
                var indexOfSecondObjective = findObjective(BundleTitle + "_" + ATType + "_Low");
                var val1 = "";
                var val2 = "";


                if (val == "High") {
                    val2 = "passed";
                    val1 = "failed"
                } else {
                    val2 = "failed";
                    val1 = "passed"
                }

                if (val1 != "passed") {
                    setObjToFailed(indexOfFirstObjective);
                } else {
                    setObjToPassed(indexOfFirstObjective);
                }

                if (val2 != "passed") {
                    setObjToFailed(indexOfSecondObjective);
                } else {
                    setObjToPassed(indexOfSecondObjective);
                }

                doSetValue("cmi.completion_status", "completed");
                doSetValue("cmi.exit", "");
                exitPageStatus = true;
                var result = doTerminate();

            },
            false);



        function GetQueryVar(search_for, defaultstr) {
            var query = window.location.search.substring(1);
            var parms = query.split('&');
            for (var i = 0; i < parms.length; i++) {
                var pos = parms[i].indexOf('=');
                if (pos > 0 && search_for == parms[i].substring(0, pos)) {
                    return parms[i].substring(pos + 1);
                }
            }
            return defaultstr;
        }



        function findandsetpas(ObjStr) {
            var index = findObjective(ObjStr);
            setObjToPassed(index);
        }



        /**********************************************************************
         **  Function: loadPage()
         **  Description: This is called when a SCO is first loaded in the
         **               browser (onload()).  It finds the API if it was not
         **               already located and calls Initialize().  In
         **               the exitPageStatus global variable is set to false
         **               indicating that the SCO is not yet finished.
         **********************************************************************/
        function loadPage() {
            var result = doInitialize();
            var html = '<div style="padding: 15px 20px;  font-weight: bold;">';
            html += '<span id="ATscore"></span>';
            html += '</div>';
            html += '<iframe src="' + GetLinks(ATType) + '" width="900" height="768" frameborder="0"/>';
            document.getElementById("disp").innerHTML = html;
        }



        /**********************************************************************
         **  Function: doQuit()
         **  Description: This function is called in the case that the user
         **               does not finish the SCO "gracefully".  For example, 
         **               the user may click the "continue" button before
         **               submitting an answer to a question.  In this case,
         **               this function is called as part of the page unloading.
         **               This function ensures that Terminate() is called
         **               and that the correct statuses are set even if the 
         **               user closes the SCO window or navigates away before 
         **               finishing the SCO.
         **********************************************************************/
        function doQuit() {
            submitScore();
        }

        /**********************************************************************
         **  Function: unloadPage()
         **  Description: This function is called in the case that the user
         **               does not finish the SCO "gracefully".  For example, 
         **               the user may click the "continue" button before
         **               submitting an answer to a question.  In this case,
         **               this function is called as part of the page unloading.
         **               This function ensures that Terminate() is called
         **               even if the user closes the SCO window or navigates
         **               away before finishing the SCO.
         **********************************************************************/
        function unloadPage() {

            if (exitPageStatus != true) {
                doQuit();
            }
        }
    </script>
    <title>AutoTutor </title>
</head>

<body onLoad="loadPage()" onunload="return unloadPage()">
    <div id="disp" name="disp"></div>
</body>

</html>